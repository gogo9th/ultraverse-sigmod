name: ultraverse-tests

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - main

permissions:
  contents: read
  packages: read

jobs:
  ultraverse-test:
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/${{ github.repository_owner }}/ultraverse-ci:ubuntu-24.04
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      GOCACHE: /tmp/go-build-cache
      GOMODCACHE: /tmp/go-mod-cache
      GOPATH: /go
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache MySQL source
        id: mysql-cache
        uses: actions/cache@v4
        with:
          path: mysql-server
          key: ${{ runner.os }}-mysql-server-9.6

      - name: Checkout MySQL Server 9.6.0
        if: steps.mysql-cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          repository: mysql/mysql-server
          ref: mysql-9.6.0
          path: mysql-server
          fetch-depth: 1

      - name: Prepare MySQL headers
        run: |
          if [ ! -f mysql-server/include/my_config.h ] || [ ! -f mysql-server/include/mysql_version.h ]; then
            cmake -S mysql-server -B mysql-server/build
            cp mysql-server/build/include/my_config.h mysql-server/build/include/mysql_version.h mysql-server/include/
          fi

      - name: Build & run tests
        run: |
          cmake -S . -B build
          cmake --build build --target allTests -j"$(nproc)"
